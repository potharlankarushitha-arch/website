<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance System ¬∑ Integrated</title>
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* ---------- SIGN IN STYLES (glassmorphism) ---------- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: linear-gradient(145deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
        }

        .signin-container {
            max-width: 480px;
            width: 100%;
            margin: 0 auto;
        }

        .brand {
            text-align: center;
            margin-bottom: 2rem;
        }

        .brand i {
            font-size: 2.8rem;
            color: #a78bfa;
            background: rgba(255,255,255,0.05);
            padding: 1rem;
            border-radius: 30px;
            margin-bottom: 0.8rem;
        }

        .brand h1 {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(to right, #c084fc, #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.02em;
        }

        .brand p {
            color: #94a3b8;
            margin-top: 0.4rem;
            font-size: 0.95rem;
        }

        .signin-card {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 48px;
            padding: 2.5rem 2rem;
            box-shadow: 0 30px 50px -20px rgba(0,0,0,0.7);
            transition: transform 0.25s ease, border-color 0.2s;
        }

        .signin-card:hover {
            border-color: rgba(167, 139, 250, 0.4);
            transform: translateY(-5px);
        }

        .role-toggle {
            display: flex;
            gap: 0.8rem;
            margin-bottom: 2.2rem;
            background: rgba(0, 0, 0, 0.25);
            padding: 0.5rem;
            border-radius: 60px;
            border: 1px solid #334155;
        }

        .role-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            padding: 0.9rem 0.5rem;
            border-radius: 40px;
            background: transparent;
            border: none;
            color: #94a3b8;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .role-btn i { font-size: 1.1rem; }
        .role-btn.active {
            background: rgba(167, 139, 250, 0.2);
            color: white;
            border: 1px solid rgba(167, 139, 250, 0.4);
        }
        .role-btn.teacher.active i { color: #c4b5fd; }
        .role-btn.student.active i { color: #5eead4; }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .input-label {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            color: #d1dbe9;
            font-weight: 450;
            font-size: 0.9rem;
        }
        .input-label i { width: 1.2rem; color: #94a3b8; }
        .input-field {
            background: rgba(0, 0, 0, 0.25);
            border: 1.5px solid #334155;
            border-radius: 40px;
            padding: 0.9rem 1.5rem;
            color: white;
            font-size: 1rem;
            outline: none;
            transition: all 0.2s;
        }
        .input-field:focus {
            border-color: #818cf8;
            background: rgba(25, 45, 70, 0.6);
            box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.15);
        }
        .input-field::placeholder { color: #64748b; font-weight: 300; }

        .domain-hint {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-top: 0.2rem;
            margin-left: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .domain-hint i { color: #60a5fa; }

        .signin-btn {
            background: linear-gradient(105deg, #3b82f6, #8b5cf6);
            border: none;
            padding: 1rem;
            border-radius: 60px;
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            margin-top: 0.5rem;
            cursor: pointer;
            transition: all 0.25s;
            border: 1px solid rgba(255,255,255,0.1);
            width: 100%;
        }
        .signin-btn:hover {
            background: linear-gradient(105deg, #2563eb, #7c3aed);
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.4);
            transform: scale(1.02);
        }

        .message-area {
            margin-top: 1.2rem;
            padding: 0.9rem 1.2rem;
            border-radius: 40px;
            font-size: 0.9rem;
            display: none;
            align-items: center;
            gap: 10px;
        }
        .message-area.show { display: flex; }
        .success-msg {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid #10b981;
            color: #d1fae5;
        }
        .error-msg {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid #ef4444;
            color: #fee2e2;
        }

        .additional-links {
            display: flex;
            justify-content: space-between;
            margin-top: 1.8rem;
            color: #94a3b8;
            font-size: 0.85rem;
        }
        .additional-links a {
            color: #a5b4fc;
            text-decoration: none;
            border-bottom: 1px dashed #4b5563;
        }

        .demo-credentials {
            margin-top: 2rem;
            padding-top: 1.2rem;
            border-top: 1px solid #1e293b;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
            color: #8198aa;
            font-size: 0.8rem;
        }
        .demo-badge {
            background: #1e2d3a;
            padding: 0.3rem 1rem;
            border-radius: 30px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        /* ---------- DASHBOARD STYLES (attendance system) ---------- */
        #dashboardPage {
            display: none;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
        }

        .dashboard-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }

        .dashboard-container header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        .dashboard-container header h1 { color: #333; font-size: 2.5em; margin-bottom: 10px; }
        .dashboard-container header p { color: #666; font-size: 1.1em; }

        .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px; }
        .panel { background: #f8f9fa; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .panel h2 { color: #444; margin-bottom: 20px; font-size: 1.5em; border-left: 4px solid #667eea; padding-left: 15px; }

        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #555; font-weight: 500; }
        select, input[type="date"], input[type="text"] {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; transition: 0.3s;
        }
        select:focus, input:focus { border-color: #667eea; outline: none; }

        .live-summary {
            display: flex; gap: 20px; margin-bottom: 20px; padding: 15px; background: white;
            border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .live-summary div { flex: 1; text-align: center; font-size: 1.1em; }
        .live-summary span { font-weight: bold; font-size: 1.3em; margin-left: 8px; }
        .present-color { color: #28a745; }
        .absent-color { color: #dc3545; }
        .late-color { color: #ffc107; }
        .total-color { color: #667eea; }

        .student-list {
            max-height: 400px; overflow-y: auto; margin-bottom: 20px;
            border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; background: white;
        }
        .student-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px; border-bottom: 1px solid #eee;
        }
        .student-item:last-child { border-bottom: none; }
        .student-info { display: flex; align-items: center; gap: 10px; }
        .student-avatar {
            width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;
        }
        .attendance-controls { display: flex; gap: 10px; }
        .status-btn {
            padding: 8px 15px; border: 1px solid #ddd; background: white;
            border-radius: 20px; cursor: pointer; transition: all 0.3s;
        }
        .status-btn.active { color: white; border-color: transparent; }
        .status-btn.present.active { background: #28a745; }
        .status-btn.absent.active { background: #dc3545; }
        .status-btn.late.active { background: #ffc107; color: #333; }

        .btn-primary {
            width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 8px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: 0.3s;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102,126,234,0.4); }

        .report-summary {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px;
        }
        .summary-card {
            background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .summary-card h3 { font-size: 0.9em; color: #666; margin-bottom: 10px; }
        .summary-card span { font-size: 2em; font-weight: bold; color: #333; }

        .report-table { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; }
        th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; }
        td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; }
        .present-badge { background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; }
        .absent-badge { background: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; }
        .late-badge { background: #ffc107; color: #333; padding: 4px 8px; border-radius: 4px; }

        .performance-section {
            background: #f8f9fa; border-radius: 15px; padding: 25px; margin-top: 30px;
        }
        .performance-section h2 {
            color: #444; margin-bottom: 20px; border-left: 4px solid #667eea; padding-left: 15px;
        }
        .performance-chart {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;
        }
        .chart-card {
            background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .chart-card h4 { margin-bottom: 15px; color: #555; }
        .progress-bar { width: 100%; height: 10px; background: #f0f0f0; border-radius: 5px; margin: 10px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s; }
        #examReportContainer { margin-top: 30px; background: white; padding: 20px; border-radius: 10px; }

        @media (max-width: 768px) {
            .main-content { grid-template-columns: 1fr; }
            .report-summary { grid-template-columns: repeat(2,1fr); }
        }
        @media (max-width: 480px) {
            .report-summary { grid-template-columns: 1fr; }
            .student-item { flex-direction: column; }
        }

        /* ---------- ROLE‚ÄëBASED HIDING ---------- */
        .student-hidden { display: none !important; }
    </style>
</head>
<body>
    <!-- ========== SIGN IN PAGE ========== -->
    <div id="signinPage" class="signin-container">
        <div class="brand">
            <i class="fas fa-clipboard-check"></i>
            <h1>Attendance System</h1>
            <p>Sign in to track your attendance</p>
        </div>
        <div class="signin-card">
            <div class="role-toggle">
                <button class="role-btn teacher active" id="teacherRoleBtn" onclick="setRole('teacher')">
                    <i class="fas fa-chalkboard-teacher"></i> Teacher
                </button>
                <button class="role-btn student" id="studentRoleBtn" onclick="setRole('student')">
                    <i class="fas fa-user-graduate"></i> Student
                </button>
            </div>
            <div class="signin-form">
                <div class="input-group">
                    <span class="input-label">
                        <i class="fas fa-envelope" id="emailIcon"></i> 
                        <span id="emailLabel">Teacher email</span>
                    </span>
                    <input type="email" class="input-field" id="emailInput" placeholder="your.email@attendance.edu" value="professor@attendance.edu">
                    <span class="domain-hint" id="domainHint">
                        <i class="fas fa-info-circle"></i> Use @attendance.edu for teacher
                    </span>
                </div>
                <div class="input-group">
                    <span class="input-label">
                        <i class="fas fa-lock"></i> Password
                    </span>
                    <input type="password" class="input-field" id="passwordInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="demo123">
                </div>
                <button class="signin-btn" id="signinBtn">
                    <i class="fas fa-arrow-right-to-bracket"></i> Sign In
                </button>
                <div id="messageBox" class="message-area"></div>
                <div class="additional-links">
                    <a href="#"><i class="fas-regular fa-lock"></i> Forgot password?</a>
                    <a href="#"><i class="fas-regular fa-headset"></i> Need help?</a>
                </div>
            </div>
            <div class="demo-credentials">
                <span class="demo-badge"><i class="fas fa-user-tie"></i> Teacher: prof@attendance.edu</span>
                <span class="demo-badge"><i class="fas fa-user-graduate"></i> Student: jane@student.edu</span>
            </div>
        </div>
        <div style="text-align: center; margin-top: 1.8rem; color: #6a7f8f; font-size: 0.8rem;">
            <i class="fas fa-shield-alt"></i> Attendance Management System ¬∑ Sign in page
        </div>
    </div>

    <!-- ========== DASHBOARD PAGE (initially hidden) ========== -->
    <div id="dashboardPage">
        <div class="dashboard-container">
            <header>
                <h1>üìã Attendance Management System</h1>
                <p id="dashboardGreeting">Track student attendance efficiently</p>
            </header>
            <div class="main-content">
                <!-- LEFT PANEL: Mark Attendance (hidden for students) -->
                <div class="panel" id="markAttendancePanel">
                    <h2>üìù Mark Attendance</h2>
                    <div class="form-group">
                        <label for="courseSelect">Select Course:</label>
                        <select id="courseSelect" onchange="loadStudents()">
                            <option value="">-- Choose Course --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dateInput">Date:</label>
                        <input type="date" id="dateInput">
                    </div>
                    <div class="live-summary">
                        <div>‚úÖ Present: <span id="markPresentCount" class="present-color">0</span></div>
                        <div>‚ùå Absent: <span id="markAbsentCount" class="absent-color">0</span></div>
                        <div>‚è∞ Late: <span id="markLateCount" class="late-color">0</span></div>
                        <div>üë• Total: <span id="markTotalCount" class="total-color">0</span></div>
                    </div>
                    <div id="studentList" class="student-list"></div>
                    <button onclick="saveAttendance()" class="btn-primary">üíæ Save Attendance</button>
                </div>
                <!-- RIGHT PANEL: Attendance Reports (visible to both) -->
                <div class="panel">
                    <h2>üìä Attendance Reports</h2>
                    <div class="form-group">
                        <label for="reportCourseSelect">Filter by Course:</label>
                        <select id="reportCourseSelect" onchange="loadReport()">
                            <option value="">All Courses</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="reportDateInput">Filter by Date:</label>
                        <input type="date" id="reportDateInput" onchange="loadReport()">
                    </div>
                    <div class="report-summary">
                        <div class="summary-card"><h3>Present</h3><span id="presentCount">0</span></div>
                        <div class="summary-card"><h3>Absent</h3><span id="absentCount">0</span></div>
                        <div class="summary-card"><h3>Late</h3><span id="lateCount">0</span></div>
                        <div class="summary-card"><h3>Total</h3><span id="totalCount">0</span></div>
                    </div>
                    <div id="reportTable" class="report-table"></div>
                    <button onclick="exportReport()" class="btn-primary" style="margin-top:20px;">üì• Export Report</button>
                </div>
            </div>
            <!-- PERFORMANCE SECTION (students see only their own) -->
            <div class="performance-section">
                <h2>üéØ Student Performance</h2>
                <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;" id="performanceControls">
                    <div class="form-group" style="flex: 2;" id="studentSearchGroup">
                        <label for="studentSearch">Search Student:</label>
                        <input type="text" id="studentSearch" placeholder="Type student name..." onkeyup="filterStudentSelect()">
                    </div>
                    <div class="form-group" style="flex: 3;">
                        <label for="studentSelect">Select Student:</label>
                        <select id="studentSelect" size="5" style="width:100%;">
                            <option value="">-- Choose Student --</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="loadStudentPerformance()" class="btn-primary" style="width: auto; padding: 12px 25px;">üìä Submit Performance</button>
                        <button onclick="generateExamReport()" class="btn-primary" style="width: auto; padding: 12px 25px; background: #28a745;">üìÑ Exam Report</button>
                    </div>
                </div>
                <div id="performanceChart" class="performance-chart"></div>
                <div id="examReportContainer"></div>
            </div>
        </div>
    </div>

    <script>
        // ---------- GLOBAL VARIABLES ----------
        let attendanceDB = {
            courses: [
                { id: 1, code: 'CS101', name: 'Computer Science 101' },
                { id: 2, code: 'MATH201', name: 'Advanced Mathematics' },
                { id: 3, code: 'PHY101', name: 'Physics Fundamentals' },
                { id: 4, code: 'ENG202', name: 'Technical Writing' }
            ],
            students: [
                { id: 1, name: 'John Doe', email: 'john@example.com' },
                { id: 2, name: 'Jane Smith', email: 'jane@student.edu' },   // student demo
                { id: 3, name: 'Mike Johnson', email: 'mike@example.com' },
                { id: 4, name: 'Sarah Wilson', email: 'sarah@example.com' },
                { id: 5, name: 'Tom Brown', email: 'tom@example.com' },
                { id: 6, name: 'Emily Davis', email: 'emily@example.com' }
            ],
            enrollments: [
                { studentId: 1, courseId: 1 },
                { studentId: 2, courseId: 1 },
                { studentId: 3, courseId: 1 },
                { studentId: 4, courseId: 2 },
                { studentId: 5, courseId: 2 },
                { studentId: 6, courseId: 3 },
                { studentId: 1, courseId: 2 },
                { studentId: 2, courseId: 3 }
            ],
            attendance: []
        };

        let currentUser = null;   // { role, email, name?, studentId? }

        // ---------- SIGN IN LOGIC ----------
        const teacherBtn = document.getElementById('teacherRoleBtn');
        const studentBtn = document.getElementById('studentRoleBtn');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const signinBtn = document.getElementById('signinBtn');
        const messageBox = document.getElementById('messageBox');
        const emailLabel = document.getElementById('emailLabel');
        const emailIcon = document.getElementById('emailIcon');
        const domainHint = document.getElementById('domainHint');

        let currentRole = 'teacher'; // default

        window.setRole = function(role) {
            currentRole = role;
            if (role === 'teacher') {
                teacherBtn.classList.add('active');
                studentBtn.classList.remove('active');
                emailLabel.textContent = 'Teacher email';
                emailInput.placeholder = 'faculty@attendance.edu';
                emailInput.value = 'professor@attendance.edu';
                domainHint.innerHTML = '<i class="fas fa-info-circle"></i> Use @attendance.edu for teacher';
                emailIcon.style.color = '#c4b5fd';
            } else {
                teacherBtn.classList.remove('active');
                studentBtn.classList.add('active');
                emailLabel.textContent = 'Student email';
                emailInput.placeholder = 'student@student.edu';
                emailInput.value = 'jane@student.edu';
                domainHint.innerHTML = '<i class="fas fa-info-circle"></i> Use @student.edu for student';
                emailIcon.style.color = '#5eead4';
            }
            messageBox.classList.remove('show', 'success-msg', 'error-msg');
        };

        function handleSignIn(e) {
            e.preventDefault();
            messageBox.classList.remove('show', 'success-msg', 'error-msg');
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            if (!email || !password) {
                messageBox.innerHTML = '<i class="fas fa-circle-exclamation"></i> ‚ùå Email and password are required.';
                messageBox.classList.add('show', 'error-msg');
                return;
            }

            if (currentRole === 'teacher') {
                if (email.includes('@attendance.edu')) {
                    // Find teacher name? we can assign a default
                    currentUser = { role: 'teacher', email: email, name: 'Professor' };
                    showDashboard();
                } else {
                    messageBox.innerHTML = '<i class="fas fa-circle-exclamation"></i> ‚ùå Teacher sign in failed. Use @attendance.edu email.';
                    messageBox.classList.add('show', 'error-msg');
                }
            } else { // student
                if (email.includes('@student.edu')) {
                    // Find student ID from DB
                    const student = attendanceDB.students.find(s => s.email === email);
                    if (student) {
                        currentUser = { role: 'student', email: email, name: student.name, studentId: student.id };
                        showDashboard();
                    } else {
                        // fallback ‚Äì treat as new student (demo)
                        currentUser = { role: 'student', email: email, name: 'Jane Smith', studentId: 2 };
                        showDashboard();
                    }
                } else {
                    messageBox.innerHTML = '<i class="fas fa-circle-exclamation"></i> ‚ùå Student sign in failed. Must use @student.edu email.';
                    messageBox.classList.add('show', 'error-msg');
                }
            }
        }

        signinBtn.addEventListener('click', handleSignIn);
        [emailInput, passwordInput].forEach(input => {
            input.addEventListener('keypress', (e) => { if (e.key === 'Enter') signinBtn.click(); });
        });

        // ---------- DASHBOARD INTEGRATION ----------
        function showDashboard() {
            // Hide sign in, show dashboard
            document.getElementById('signinPage').style.display = 'none';
            document.getElementById('dashboardPage').style.display = 'block';

            // Personalize greeting
            const greeting = document.getElementById('dashboardGreeting');
            greeting.textContent = `Welcome, ${currentUser.name} (${currentUser.role}) ¬∑ ${currentUser.email}`;

            // Role‚Äëbased UI adjustments
            if (currentUser.role === 'student') {
                // Hide "Mark Attendance" panel entirely
                document.getElementById('markAttendancePanel').classList.add('student-hidden');
                // Hide search field ‚Äì student can only see themselves
                document.getElementById('studentSearchGroup').style.display = 'none';
                // Pre‚Äëselect the student in dropdown and load their performance
                setTimeout(() => {
                    const studentSelect = document.getElementById('studentSelect');
                    // Find option with matching studentId
                    for (let opt of studentSelect.options) {
                        if (opt.value == currentUser.studentId) {
                            opt.selected = true;
                            break;
                        }
                    }
                    loadStudentPerformance();
                }, 100);
            } else {
                // Teacher: everything visible
                document.getElementById('markAttendancePanel').classList.remove('student-hidden');
                document.getElementById('studentSearchGroup').style.display = 'block';
            }

            // Initialize dashboard data
            initializeApp();
            setDefaultDate();
            loadCourses();
            loadStudents();
            loadReport();
            loadStudentSelect();
        }

        // ---------- DASHBOARD FUNCTIONS (adapted from original) ----------
        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('dateInput');
            const reportDateInput = document.getElementById('reportDateInput');
            if (dateInput) dateInput.value = today;
            if (reportDateInput) reportDateInput.value = today;
        }

        function initializeApp() {
            const savedData = localStorage.getItem('attendanceDB');
            if (savedData) {
                try { attendanceDB = JSON.parse(savedData); } catch(e) { console.error(e); }
            }
        }

        function saveToLocalStorage() {
            localStorage.setItem('attendanceDB', JSON.stringify(attendanceDB));
        }

        function loadCourses() {
            const courseSelect = document.getElementById('courseSelect');
            const reportCourseSelect = document.getElementById('reportCourseSelect');
            if (!courseSelect || !reportCourseSelect) return;
            courseSelect.innerHTML = '<option value="">-- Choose Course --</option>';
            reportCourseSelect.innerHTML = '<option value="">All Courses</option>';
            attendanceDB.courses.forEach(course => {
                courseSelect.innerHTML += `<option value="${course.id}">${course.code} - ${course.name}</option>`;
                reportCourseSelect.innerHTML += `<option value="${course.id}">${course.code} - ${course.name}</option>`;
            });
        }

        function loadStudents() {
            // Only teachers need to load students for marking
            if (currentUser.role !== 'teacher') return;
            const courseId = document.getElementById('courseSelect').value;
            const studentList = document.getElementById('studentList');
            if (!courseId) {
                studentList.innerHTML = '<p style="color:#666; text-align:center;">Please select a course first</p>';
                return;
            }
            const enrolledIds = attendanceDB.enrollments.filter(e => e.courseId == courseId).map(e => e.studentId);
            const enrolledStudents = attendanceDB.students.filter(s => enrolledIds.includes(s.id));
            if (enrolledStudents.length === 0) {
                studentList.innerHTML = '<p style="color:#666; text-align:center;">No students enrolled</p>';
                return;
            }

            let html = '<h3 style="margin-bottom:15px;">Enrolled Students</h3>';
            enrolledStudents.forEach(student => {
                const initials = student.name.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase();
                html += `<div class="student-item" id="student-${student.id}">
                            <div class="student-info">
                                <div class="student-avatar">${initials}</div>
                                <div><strong>${student.name}</strong><br><small>${student.email}</small></div>
                            </div>
                            <div class="attendance-controls">
                                <button class="status-btn present" onclick="setAttendanceStatus(${student.id}, 'present', this)">Present</button>
                                <button class="status-btn absent" onclick="setAttendanceStatus(${student.id}, 'absent', this)">Absent</button>
                                <button class="status-btn late" onclick="setAttendanceStatus(${student.id}, 'late', this)">Late</button>
                            </div>
                        </div>`;
            });
            studentList.innerHTML = html;

            setTimeout(() => {
                document.querySelectorAll('.student-item').forEach(item => {
                    const presentBtn = item.querySelector('.status-btn.present');
                    if (presentBtn) {
                        presentBtn.classList.add('active', 'present');
                        item.dataset.status = 'present';
                    }
                });
                updateMarkSummary();
            }, 50);
        }

        function setAttendanceStatus(studentId, status, element) {
            const studentItem = document.getElementById(`student-${studentId}`);
            if (!studentItem) return;
            const buttons = studentItem.querySelectorAll('.status-btn');
            buttons.forEach(btn => btn.classList.remove('active', 'present', 'absent', 'late'));
            element.classList.add('active', status);
            studentItem.dataset.status = status;
            updateMarkSummary();
        }

        function updateMarkSummary() {
            const studentItems = document.querySelectorAll('.student-item');
            let present = 0, absent = 0, late = 0;
            studentItems.forEach(item => {
                const status = item.dataset.status || 'present';
                if (status === 'present') present++;
                else if (status === 'absent') absent++;
                else if (status === 'late') late++;
            });
            document.getElementById('markPresentCount').textContent = present;
            document.getElementById('markAbsentCount').textContent = absent;
            document.getElementById('markLateCount').textContent = late;
            document.getElementById('markTotalCount').textContent = studentItems.length;
        }

        function saveAttendance() {
            if (currentUser.role !== 'teacher') {
                alert('Only teachers can save attendance.');
                return;
            }
            const courseId = document.getElementById('courseSelect').value;
            const date = document.getElementById('dateInput').value;
            if (!courseId || !date) { alert('Please select course and date'); return; }
            const studentItems = document.querySelectorAll('.student-item');
            if (studentItems.length === 0) { alert('No students to mark'); return; }
            let savedCount = 0;
            studentItems.forEach(item => {
                const studentId = item.id.replace('student-', '');
                const status = item.dataset.status || 'present';
                const existingIndex = attendanceDB.attendance.findIndex(a => a.studentId == studentId && a.courseId == courseId && a.date == date);
                if (existingIndex !== -1) {
                    attendanceDB.attendance[existingIndex].status = status;
                } else {
                    attendanceDB.attendance.push({
                        id: attendanceDB.attendance.length + 1,
                        studentId: parseInt(studentId),
                        courseId: parseInt(courseId),
                        date: date,
                        status: status,
                        timestamp: new Date().toISOString()
                    });
                }
                savedCount++;
            });
            saveToLocalStorage();
            alert(`‚úÖ Attendance saved for ${savedCount} students`);
            loadReport();
        }

        function loadReport() {
            const courseId = document.getElementById('reportCourseSelect').value;
            const date = document.getElementById('reportDateInput').value;
            let filtered = [...attendanceDB.attendance];
            if (courseId) filtered = filtered.filter(a => a.courseId == courseId);
            if (date) filtered = filtered.filter(a => a.date == date);

            const present = filtered.filter(a => a.status === 'present').length;
            const absent = filtered.filter(a => a.status === 'absent').length;
            const late = filtered.filter(a => a.status === 'late').length;
            document.getElementById('presentCount').textContent = present;
            document.getElementById('absentCount').textContent = absent;
            document.getElementById('lateCount').textContent = late;
            document.getElementById('totalCount').textContent = filtered.length;

            let html = `<table><thead><tr><th>Student</th><th>Course</th><th>Date</th><th>Status</th></tr></thead><tbody>`;
            if (filtered.length === 0) {
                html += `<tr><td colspan="4" style="padding:30px; text-align:center;">üìä No records</td></tr>`;
            } else {
                filtered.forEach(r => {
                    const student = attendanceDB.students.find(s => s.id === r.studentId);
                    const course = attendanceDB.courses.find(c => c.id === r.courseId);
                    let badge = '', statusText = '';
                    if (r.status === 'present') { badge = 'present-badge'; statusText = 'PRESENT'; }
                    else if (r.status === 'absent') { badge = 'absent-badge'; statusText = 'ABSENT'; }
                    else { badge = 'late-badge'; statusText = 'LATE'; }
                    html += `<tr><td><strong>${student?.name || 'Unknown'}</strong></td>
                            <td>${course?.code || 'Unknown'}</td>
                            <td>${formatDate(r.date)}</td>
                            <td><span class="${badge}">${statusText}</span></td></tr>`;
                });
            }
            html += `</tbody></table>`;
            document.getElementById('reportTable').innerHTML = html;
        }

        function loadStudentSelect() {
            const select = document.getElementById('studentSelect');
            if (!select) return;
            select.innerHTML = '<option value="">-- Choose Student --</option>';
            attendanceDB.students.forEach(s => {
                select.innerHTML += `<option value="${s.id}">${s.name}</option>`;
            });
        }

        function filterStudentSelect() {
            const search = document.getElementById('studentSearch').value.toLowerCase();
            const select = document.getElementById('studentSelect');
            Array.from(select.options).forEach(opt => {
                opt.style.display = opt.text.toLowerCase().includes(search) ? 'block' : 'none';
            });
        }

        function loadStudentPerformance() {
            let studentId = document.getElementById('studentSelect').value;
            // If student is logged in, force their own ID
            if (currentUser.role === 'student') {
                studentId = currentUser.studentId;
            }
            const chart = document.getElementById('performanceChart');
            if (!studentId) {
                chart.innerHTML = '<p style="color:#666; text-align:center;">Select a student</p>';
                return;
            }
            const enrolledCourseIds = attendanceDB.enrollments.filter(e => e.studentId == studentId).map(e => e.courseId);
            const courses = attendanceDB.courses.filter(c => enrolledCourseIds.includes(c.id));
            let html = '';
            if (courses.length === 0) {
                html = '<p style="color:#666; text-align:center;">Not enrolled in any course</p>';
            } else {
                courses.forEach(course => {
                    const records = attendanceDB.attendance.filter(a => a.studentId == studentId && a.courseId == course.id);
                    const total = records.length;
                    const present = records.filter(a => a.status === 'present').length;
                    const percent = total ? ((present / total) * 100).toFixed(1) : 0;
                    html += `<div class="chart-card">
                                <h4>${course.code} - ${course.name}</h4>
                                <div style="display:flex; justify-content:space-between;">
                                    <span>Attendance:</span>
                                    <strong style="color:${percent>=75?'#28a745':'#dc3545'}">${percent}%</strong>
                                </div>
                                <div class="progress-bar"><div class="progress-fill" style="width:${percent}%;"></div></div>
                                <div style="display:flex; justify-content:space-between; margin-top:10px; color:#666;">
                                    <span>‚úÖ ${present}</span>
                                    <span>üìö ${total}</span>
                                </div>
                            </div>`;
                });
            }
            chart.innerHTML = html;
        }

        function generateExamReport() {
            const container = document.getElementById('examReportContainer');
            let html = '<h3>üìã Exam Attendance Report</h3><table><tr><th>Student</th><th>Course</th><th>Present</th><th>Absent</th><th>Late</th><th>Total</th><th>%</th></tr>';
            attendanceDB.students.forEach(student => {
                const studentAttendance = attendanceDB.attendance.filter(a => a.studentId === student.id);
                const courseIds = [...new Set(studentAttendance.map(a => a.courseId))];
                if (courseIds.length === 0) {
                    html += `<tr><td>${student.name}</td><td colspan="6" style="color:#999;">No attendance records</td></tr>`;
                } else {
                    courseIds.forEach(courseId => {
                        const course = attendanceDB.courses.find(c => c.id === courseId);
                        const recs = studentAttendance.filter(a => a.courseId === courseId);
                        const present = recs.filter(a => a.status === 'present').length;
                        const absent = recs.filter(a => a.status === 'absent').length;
                        const late = recs.filter(a => a.status === 'late').length;
                        const total = recs.length;
                        const percent = total ? ((present / total) * 100).toFixed(1) : 0;
                        html += `<tr>
                            <td>${student.name}</td>
                            <td>${course?.code || 'N/A'}</td>
                            <td>${present}</td>
                            <td>${absent}</td>
                            <td>${late}</td>
                            <td>${total}</td>
                            <td style="color:${percent>=75?'green':'red'}">${percent}%</td>
                        </tr>`;
                    });
                }
            });
            html += '</table>';
            container.innerHTML = html;
        }

        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }

        function exportReport() {
            const courseId = document.getElementById('reportCourseSelect').value;
            const date = document.getElementById('reportDateInput').value;
            let filtered = [...attendanceDB.attendance];
            if (courseId) filtered = filtered.filter(a => a.courseId == courseId);
            if (date) filtered = filtered.filter(a => a.date == date);
            if (filtered.length === 0) { alert('No data to export'); return; }
            let csv = 'Student Name,Email,Course,Date,Status\n';
            filtered.forEach(r => {
                const student = attendanceDB.students.find(s => s.id === r.studentId);
                const course = attendanceDB.courses.find(c => c.id === r.courseId);
                csv += `"${student?.name || 'Unknown'}","${student?.email || ''}","${course?.code || ''}",${r.date},${r.status}\n`;
            });
            const blob = new Blob([csv], {type:'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `attendance_${date || 'all'}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Optional: add sample data for testing
        function addSampleAttendance() {
            const today = new Date().toISOString().split('T')[0];
            attendanceDB.attendance = [
                { id:1, studentId:1, courseId:1, date:today, status:'present', timestamp: new Date().toISOString() },
                { id:2, studentId:2, courseId:1, date:today, status:'present' },
                { id:3, studentId:3, courseId:1, date:today, status:'late' }
            ];
            saveToLocalStorage();
            loadReport();
        }

        // Expose functions globally
        window.loadStudents = loadStudents;
        window.setAttendanceStatus = setAttendanceStatus;
        window.saveAttendance = saveAttendance;
        window.loadReport = loadReport;
        window.filterStudentSelect = filterStudentSelect;
        window.loadStudentPerformance = loadStudentPerformance;
        window.generateExamReport = generateExamReport;
        window.exportReport = exportReport;
        window.addSampleAttendance = addSampleAttendance;
    </script>
</body>
</html>